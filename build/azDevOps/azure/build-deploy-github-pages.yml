name: $(Build.SourceBranchName)-init

pr:
  - master
  - staging

trigger:
  branches:
    include:
      - 'master'
      - 'staging'
  paths:
    include:
      - '*'

resources:
  repositories:
    - repository: templates
      type: github
      name: amido/stacks-pipeline-templates
      ref: refs/tags/v1.4.23
      endpoint: amidostacks
  containers:
    - container: node
      image: amidostacks/node:0.0.3
    - container: k8s
      image: amidostacks/ci-k8s:0.0.11
    - container: terraform_custom
      image: amidostacks/ci-tf:0.0.4

variables:
  - name: company
    value: "amido"
  - name: project
    value: "stacks"
  - name: component
    value: "website"
  - name: pool_vm_image
    value: ubuntu-18.04
  # - name: node_version
  #   value: 12.x
  - name: resource_region
    value: northeurope
  # Self Config
  - name: self_repo
    value: amido.github.io
  - name: self_repo_dir
    value: "$(Agent.BuildDirectory)/s/$(self_repo)"
  - name: self_repo_tf_src
    value: "deploy/azure/app/site"
  - name: self_repo_tf_dir
    value: "$(self_repo_dir)/$(self_repo_tf_src)"
  - name: self_pipeline_repo
    value: "$(Agent.BuildDirectory)/s/stacks-pipeline-templates"
  - name: self_pipeline_scripts_dir
    value: "$(self_pipeline_repo)/scripts"
  - name: site_build_dir
    value: "$(self_repo_dir)/dist"
  - name: npm_cache_dir
    value: "$(self_repo_dir)/.npm"
  # TF State Config
  - name: tf_state_rg
    value: "amido-stacks-rg-uks"
  - name: tf_state_storage
    value: "amidostackstfstategbl"
  - name: tf_state_container
    value: "tfstate"
  - name: tf_state_key
    value: "stacks-website"
  # Versioning
  - name: version_major
    value: 0
  - name: version_minor
    value: 0
  - name: version_revision
    value: "$[counter(join(variables['version_major'], join('-', variables['version_minor'])), 0)]"
  - name: version_number
    value: "${{ variables.version_major }}.${{ variables.version_minor }}.$(version_revision)"
  # Yamllint
  - name: yamllint_config_file
    value: "${{ variables.self_repo_dir }}/yamllint.conf"
  - name: yamllint_scan_directory
    value: "."
  # Hostnames
  - name: hostname_nonprod
    value: "dev-stacks.amido.com"
  - name: hostname_prod
    value: "stacks.amido.com"
  # # Groups
  # - group: amido-stacks-webapp

stages:
  - stage: Build
    jobs:
      - job: Validation
        pool:
          vmImage: ${{ variables.pool_vm_image }}
        steps:
          - checkout: self

          - checkout: templates

          # Update Build Number
          - template: azDevOps/azure/templates/v2/steps/build-updatebuildnumber-dotnet.yml@templates
            parameters:
              sourcebranch_name: "$(Build.SourceBranchName)"
              raw_version_number: "${{ variables.version_number }}"

          - template: templates/steps/build/build-validate.yml
            parameters:
              repository_directory: "${{ variables.self_repo_dir }}"
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
              # YAML Lint
              yamllint_container: "k8s"
              yamllint_config_file: "${{ variables.yamllint_config_file }}"
              yamllint_scan_directory: "${{ variables.yamllint_scan_directory }}"
              # Terraform
              terraform_container: "terraform_custom"
              terraform_directory: "${{ variables.self_repo_tf_dir }}"
              # NPM Cache directory
              npm_cache_dir: "${{ variables.npm_cache_dir }}"

  - stage: Dev
    condition: and(contains(variables['Build.SourceBranch'], 'refs/heads/staging'), succeeded())
    jobs:
      - deployment: SiteInfraDev
        container: terraform_custom
        pool:
          vmImage: ${{ variables.pool_vm_image }}
        environment: dev
        variables:
          - group: amido-stacks-infra-credentials-nonprod
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-infra.yml
                  parameters:
                    environment_name: "$(Environment.Name)"
                    repository_directory: "${{ variables.self_repo_dir }}"
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    company: "${{ variables.company }}"
                    project: "${{ variables.project }}"
                    # Terraform
                    terraform_directory: "${{ variables.self_repo_tf_dir }}"
                    terraform_backend_client_id: "$(azure_client_id)"
                    terraform_backend_client_secret: "$(azure_client_secret)"
                    terraform_backend_tenant_id: "$(azure_tenant_id)"
                    terraform_backend_subscription_id: "$(azure_subscription_id)"
                    terraform_state_rg: ${{ variables.tf_state_rg }}
                    terraform_state_storage: ${{ variables.tf_state_storage }}
                    terraform_state_container: ${{ variables.tf_state_container }}
                    terraform_state_key: ${{ variables.tf_state_key }}
                    terraform_extra_properties:
                      {
                        TF_VAR_name_company: "${{ variables.company }}",
                        TF_VAR_name_project: "${{ variables.project }}",
                        TF_VAR_name_component: "${{ variables.component }}",
                        TF_VAR_stage: "$(Environment.Name)",

                        TF_VAR_resource_group_location: "${{ variables.resource_region }}",

                        TF_VAR_index_doc: "index.html",
                        TF_VAR_error_doc: "404.html",
                        TF_VAR_account_replication_type: "LRS",
                        TF_VAR_account_kind: "StorageV2",
                        TF_VAR_account_tier: "Standard",
                        TF_VAR_account_min_tls_version: "TLS1_2",

                        TF_VAR_response_header_cdn: '[
                          {
                            action: "Append",
                            name: "Content-Security-Policy",
                            value: "default-src * ''unsafe-inline'' ''unsafe-eval''"
                          },
                          {
                            action:"Append",
                            name: "Cache-Control",
                            value: "no-cache"
                          },
                          {
                            action: "Append",
                            name: "X-Frame-Options",
                            value: "SAMEORIGIN"
                          },
                          {
                            action: "Append",
                            name: "X-Content-Type-Options",
                            value: "nosniff"
                          },
                          {
                            action: "Append",
                            name: "Strict-Transport-Security",
                            value: "max-age=63072000"
                          },
                          {
                            action: "Append",
                            name: "Referrer-Policy",
                            value: "no-referrer-when-downgrade"
                          },
                          {
                            action: "Append",
                            name: "X-XSS-Protection",
                            value: "1; mode=block;"
                          }
                        ]',
                        TF_VAR_app_hostname: "${{ variables.hostname_nonprod }}",
                      }
                    # Azure Config
                    azure_client_id: "$(azure_client_id)"
                    azure_client_secret: "$(azure_client_secret)"
                    azure_tenant_id: "$(azure_tenant_id)"
                    azure_subscription_id: "$(azure_subscription_id)"

      - deployment: DeployDev
        dependsOn: SiteInfraDev
        container: k8s
        pool:
          vmImage: ${{ variables.pool_vm_image }}
        environment: dev
        variables:
          - name: website_resource_group
            value: "$[ dependencies.SiteInfraDev.outputs['SiteInfraDev.tfoutputs.website_resource_group'] ]"
          - name: storage_account_name
            value: "$[ dependencies.SiteInfraDev.outputs['SiteInfraDev.tfoutputs.storage_account_name'] ]"
          - name: storage_account_key
            value: "$[ dependencies.SiteInfraDev.outputs['SiteInfraDev.tfoutputs.storage_account_key'] ]"
          - name: cdn_profile_name
            value: "$[ dependencies.SiteInfraDev.outputs['SiteInfraDev.tfoutputs.cdn_profile_name'] ]"
          - name: cdn_endpoint_name
            value: "$[ dependencies.SiteInfraDev.outputs['SiteInfraDev.tfoutputs.cdn_endpoint_name'] ]"
          # Groups
          - group: amido-stacks-infra-credentials-nonprod
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-website.yml
                  parameters:
                    repository_directory: "${{ variables.self_repo_dir }}"
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    # Azure Credentials
                    azure_client_id: "$(azure_client_id)"
                    azure_client_secret: "$(azure_client_secret)"
                    azure_tenant_id: "$(azure_tenant_id)"
                    azure_subscription_id: "$(azure_subscription_id)"
                    # Npm
                    npm_cache_dir: "${{ variables.npm_cache_dir }}"
                    # Website
                    site_build_dir: "${{ variables.site_build_dir }}"
                    storage_account_name: "$(storage_account_name)"
                    storage_account_key: "$(storage_account_key)"
                    cdn_resource_group: "$(website_resource_group)"
                    cdn_endpoint_name: "$(cdn_endpoint_name)"
                    cdn_profile_name: "$(cdn_profile_name)"

  - stage: Prod
    # condition: and(contains(variables['Build.SourceBranch'], 'refs/heads/master'), succeeded())
    jobs:
      - deployment: SiteInfraProd
        container: terraform_custom
        pool:
          vmImage: ${{ variables.pool_vm_image }}
        environment: prod
        variables:
          - group: amido-stacks-infra-credentials-prod
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-infra.yml
                  parameters:
                    environment_name: "$(Environment.Name)"
                    repository_directory: "${{ variables.self_repo_dir }}"
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    company: "${{ variables.company }}"
                    project: "${{ variables.project }}"
                    # Terraform
                    terraform_directory: "${{ variables.self_repo_tf_dir }}"
                    terraform_backend_azure_client_id: "$(prod_azure_client_id)"
                    terraform_backend_azure_client_secret: "$(prod_azure_client_secret)"
                    terraform_backend_azure_tenant_id: "$(prod_azure_tenant_id)"
                    terraform_backend_azure_subscription_id: "$(prod_azure_subscription_id)"
                    terraform_state_rg: ${{ variables.tf_state_rg }}
                    terraform_state_storage: ${{ variables.tf_state_storage }}
                    terraform_state_container: ${{ variables.tf_state_container }}
                    terraform_state_key: ${{ variables.tf_state_key }}
                    terraform_extra_properties:
                      {
                        TF_VAR_name_company: "${{ variables.company }}",
                        TF_VAR_name_project: "${{ variables.project }}",
                        TF_VAR_name_component: "${{ variables.component }}",
                        TF_VAR_stage: "$(Environment.Name)",

                        TF_VAR_resource_group_location: "${{ variables.resource_region }}",

                        TF_VAR_index_doc: "index.html",
                        TF_VAR_error_doc: "404.html",
                        TF_VAR_account_replication_type: "LRS",
                        TF_VAR_account_kind: "StorageV2",
                        TF_VAR_account_tier: "Standard",
                        TF_VAR_account_min_tls_version: "TLS1_2",

                        TF_VAR_response_header_cdn: '[
                          {
                            action: "Append",
                            name: "Content-Security-Policy",
                            value: "default-src * ''unsafe-inline'' ''unsafe-eval''"
                          },
                          {
                            action:"Append",
                            name: "Cache-Control",
                            value: "no-cache"
                          },
                          {
                            action: "Append",
                            name: "X-Frame-Options",
                            value: "SAMEORIGIN"
                          },
                          {
                            action: "Append",
                            name: "X-Content-Type-Options",
                            value: "nosniff"
                          },
                          {
                            action: "Append",
                            name: "Strict-Transport-Security",
                            value: "max-age=63072000"
                          },
                          {
                            action: "Append",
                            name: "Referrer-Policy",
                            value: "no-referrer-when-downgrade"
                          },
                          {
                            action: "Append",
                            name: "X-XSS-Protection",
                            value: "1; mode=block;"
                          }
                        ]',
                        TF_VAR_app_hostname: "${{ variables.hostname_prod }}",
                      }
                    # Azure Config
                    azure_client_id: "$(prod_azure_client_id)"
                    azure_client_secret: "$(prod_azure_client_secret)"
                    azure_tenant_id: "$(prod_azure_tenant_id)"
                    azure_subscription_id: "$(prod_azure_subscription_id)"

      - deployment: DeployProd
        dependsOn: SiteInfraProd
        container: k8s
        pool:
          vmImage: ${{ variables.pool_vm_image }}
        environment: prod
        variables:
          - name: website_resource_group
            value: "$[ dependencies.SiteInfraProd.outputs['SiteInfraProd.tfoutputs.website_resource_group'] ]"
          - name: storage_account_name
            value: "$[ dependencies.SiteInfraProd.outputs['SiteInfraProd.tfoutputs.storage_account_name'] ]"
          - name: storage_account_key
            value: "$[ dependencies.SiteInfraProd.outputs['SiteInfraProd.tfoutputs.storage_account_key'] ]"
          - name: cdn_profile_name
            value: "$[ dependencies.SiteInfraProd.outputs['SiteInfraProd.tfoutputs.cdn_profile_name'] ]"
          - name: cdn_endpoint_name
            value: "$[ dependencies.SiteInfraProd.outputs['SiteInfraProd.tfoutputs.cdn_endpoint_name'] ]"
          # Groups
          - group: amido-stacks-infra-credentials-prod
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-website.yml
                  parameters:
                    repository_directory: "${{ variables.self_repo_dir }}"
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    # Azure Credentials
                    azure_client_id: "$(prod_azure_client_id)"
                    azure_client_secret: "$(prod_azure_client_secret)"
                    azure_tenant_id: "$(prod_azure_tenant_id)"
                    azure_subscription_id: "$(prod_azure_subscription_id)"
                    # Npm
                    npm_cache_dir: "${{ variables.npm_cache_dir }}"
                    # Website
                    site_build_dir: "${{ variables.site_build_dir }}"
                    storage_account_name: "$(storage_account_name)"
                    storage_account_key: "$(storage_account_key)"
                    cdn_resource_group: "$(website_resource_group)"
                    cdn_endpoint_name: "$(cdn_endpoint_name)"
                    cdn_profile_name: "$(cdn_profile_name)"
